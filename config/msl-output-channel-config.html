<script type="text/javascript">
    RED.nodes.registerType('msl-output-channel-config',{
        category: 'config',
        defaults: {
            hostname: {value: ""},
            devices: {value: []},
            device: {value: {}},
            subdevice: {value: {}},
            channel: {value: {}}
        },
        label: function() {
            return this.channel.channelname || "msl-output-channel-config";
        },
        oneditprepare: function() {
            // Set all the variables
            let node = this;
            let deviceInputEl = $("#input-device");
            let subDeviceInputEl = $("#input-subdevice");
            let channelInputEl = $("#input-channel");

            // Prepopulate input fields if neccessary
            if(node.devices.length) {
                deviceInputEl.empty();
                node.devices.forEach(device => deviceInputEl.html(deviceInputEl.html() + `<option value="${device.hostname}">${device.hostname}</option>`));
                deviceInputEl.val(node.device.hostname).change()
                if(!$.isEmptyObject(node.subdevice)) {
                    console.log('subdevice: ', node.subdevice);
                    node.device.devices.forEach(device => subDeviceInputEl.html(subDeviceInputEl.html() + `<option value="${device.devicename}">${device.devicename}</option>`));
                    subDeviceInputEl.val(node.subdevice.devicename).change();
                    if(!$.isEmptyObject(node.channel)) {
                        console.log('channel: ', node.channel);
                        node.subdevice.channels.forEach(channel => channelInputEl.html(channelInputEl.html() + `<option value="${channel.channelid}">${channel.channelname}</option>`))
                        channelInputEl.val(node.channel.channelid).change();
                    }
                }
            };

            // Functionality to add a device
            $(".new-device-btn").on("click", onNewDevice);
            $("#input-new-device").on('keypress', function(e) {
                if(e.which === 13) {
                    onNewDevice(e.target);
                }
            })
            function onNewDevice (element) {
                let hostname = $("#input-new-device").val();
                node.hostname = hostname;
                if(node.devices && node.devices.find(device => device.hostname === hostname)) return;
                $.get(`http://${hostname}/devicetree/`, function (data) {
                    let device = {
                        hostname: hostname,
                        devices: data.items
                    }
                    console.log("received new device: ", device);
                    deviceInputEl.trigger("new-device", device);
                    if(node.devices) {
                        node.devices.push(device);
                    } else {
                        node.devices = [];
                        node.devices.push(device);
                    }
                    console.log(node.devices);                       
                }).fail(function() {
                    alert("Gerät konnte nicht gefunden werden.");
                });
            }

            // Functionality after a device has been added
            deviceInputEl.on("new-device", function (event, device) {
                this.innerHTML += `<option value="${device.hostname}">${device.hostname}</option>`;
            })

            deviceInputEl.on("change", function(event) {
                let deviceHostname = deviceInputEl.val();
                if(deviceHostname) {
                    subDeviceInputEl.html("");
                    let device = node.devices.find(device => device.hostname === deviceHostname);
                    console.log("selected device: ", device);
                    node.device = device;
                    device.devices.forEach(device => {
                        subDeviceInputEl.html(subDeviceInputEl.html() + `<option value="${device.devicename}">${device.devicename}</option>`);
                    })
                    subDeviceInputEl.change();
                }
            })

            // Functionality after a subdevice has been choosen
            subDeviceInputEl.on("change", function(event) {
                let subdevice = node.device.devices.find(subdevice => subdevice.devicename === subDeviceInputEl.val());
                // Filter only output channels
                let outputChannelIDs = [3, 5, 7, 21, 51];
                subdevice.channels = subdevice.channels.filter(channel => outputChannelIDs.includes(channel.channeltype));
                node.subdevice = subdevice;
                console.log("subdevice: ", subdevice);
                subdevice.channels.length ? channelInputEl.html(`<option value="" selected disabled hidden>Kanal auswählen</option>`) : channelInputEl.html("");
                subdevice.channels.forEach(channel => channelInputEl.html(channelInputEl.html() + `<option value="${channel.channelid}">${channel.channelname}</option>`));
            })

            // Functionality for when a channel has been selected
            channelInputEl.on("change", function (event) {
                console.log(channelInputEl.val());
                let channel = node.subdevice.channels.find(channel => channel.channelid === parseInt(channelInputEl.val()));
                console.log("channel", channel);
                node.channel = channel;
            })
        }
    });
</script>

<script type="text/html" data-template-name="msl-output-channel-config">
    <style>
        .device-input-container {
            display: inline;
        }
        .icon {
            position: absolute;
            right: 65px;
            margin-top: 3px;
            font-size: 30px;
            cursor: pointer;
        }
    </style>
    <div class="form-row">
        <label for="new-device">Neues Gerät</label>
        <div class="device-input-container">
            <i class="fa fa-plus icon new-device-btn"></i>
            <input type="text" id="input-new-device" placeholder="Hostname/IP">
        </div>
    </div>
    <div class="form-row">
        <label for="device">Gerät</label>
        <select id="input-device">
            <option value="" selected disabled hidden>Gerät auswählen</option>
        </select>
    </div>
    <div class="form-row">
        <label for="sub-device">Verb. Gerät</label>
        <select id="input-subdevice">
            <option value="" selected disabled hidden>Gerät auswählen</option>
        </select>
    </div>
    <div class="form-row">
        <label for="channel">Kanal</label>
        <select id="input-channel">
            <option value="" selected disabled hidden>Kanal auswählen</option>
        </select>
    </div>
</script>